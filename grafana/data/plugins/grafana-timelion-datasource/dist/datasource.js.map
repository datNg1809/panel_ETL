{"version":3,"sources":["../src/datasource.js"],"names":["_","TimelionDatasource","instanceSettings","$q","backendSrv","templateSrv","timeSrv","jsonData","esVersion","type","url","name","q","options","headers","datasourceRequest","query","buildQueryParameters","oThis","targets","length","when","data","reqs","map","queries","request","method","then","readTimlionSeries","response","list","ix","label","d","all","flatten","series","sheet","testQuery","status","message","title","body","target","annotation","scopedVars","novalue","parseFloat","createAnnotations","reduce","result","filter","datapoints","dp","timestamp","acc","v","concat","text","match","s","replace","RegExp","m","regexp","exec","annotationReplace","tags","queryResult","res","Object","assign","enable","annotationInfo","r","interpolated","range","timeRange","i","value","isObject","hide","queryTpl","from","utc","format","to","expandTemplate","keys","key","trim","interval","variables","t","indexOf","join","intervalGroups","groupBy","intervals","time","cloneDeep"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\r\n\r\nexport class TimelionDatasource {\r\n\r\n  constructor(instanceSettings, $q, backendSrv, templateSrv, timeSrv) {\r\n    instanceSettings.jsonData = instanceSettings.jsonData || {};\r\n    this.instanceSettings = instanceSettings;\r\n    this.esVersion = instanceSettings.jsonData.esVersion || \"5.3.0\";\r\n    this.type = instanceSettings.type;\r\n    this.url = instanceSettings.url;\r\n    this.name = instanceSettings.name;\r\n    this.q = $q;\r\n    this.backendSrv = backendSrv;\r\n    this.templateSrv = templateSrv;\r\n    this.timeSrv = timeSrv;\r\n  }\r\n\r\n  request(options) {\r\n    options.headers = {\r\n      \"kbn-version\": this.esVersion,\r\n      \"Content-Type\": \"application/json;charset=UTF-8\"\r\n    };\r\n    return this.backendSrv.datasourceRequest(options);\r\n  }\r\n\r\n  query(options) {\r\n    var query = this.buildQueryParameters(options);\r\n    var oThis = this;\r\n    if (query.targets.length <= 0) {\r\n      return this.q.when({ data: [] });\r\n    }\r\n    var reqs = _.map(options.queries,\r\n      query => oThis.request({\r\n        url: this.url + '/run',\r\n        data: query,\r\n        method: 'POST'\r\n      })\r\n        .then(response => oThis.readTimlionSeries(response)\r\n          .map((list, ix) => ({\r\n            \"target\": list.label,\r\n            \"datapoints\": _.map(list.data, d => [d[1], d[0]])\r\n          }))));\r\n    return this.q.all(reqs).then(series => ({ \"data\": _.flatten(series) }))\r\n  }\r\n\r\n  readTimlionSeries(response) {\r\n    return _.flatten(_.map(response.data.sheet, sheet => sheet.list));\r\n  }\r\n\r\n  testDatasource() {\r\n    var testQuery = {\r\n      \"sheet\": [\".es(*)\"],\r\n      \"time\": {\r\n        \"from\": \"now-1m\",\r\n        \"to\": \"now\",\r\n        \"mode\": \"quick\",\r\n        \"interval\": \"auto\",\r\n        \"timezone\": \"Europe/Berlin\"\r\n      }\r\n    };\r\n    return this.request({\r\n      url: this.url + '/run',\r\n      method: 'POST',\r\n      data: testQuery\r\n    }).then(response => {\r\n      if (response.status === 200) {\r\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\r\n      } else {\r\n        return { status: \"error\", message: response.body, title: `Error ${response.status}` };\r\n      }\r\n    });\r\n  }\r\n\r\n  annotationQuery(options) {\r\n    options.targets = [{ target: options.annotation.query }];\r\n    options.scopedVars = {};\r\n    var novalue = parseFloat(options.annotation.novalue||0);\r\n    return this.query(options)\r\n      .then(result => this.createAnnotations(options,\r\n        _.reduce(\r\n          _.map(result.data, d =>\r\n            _.map(_.filter(d.datapoints, d => d[0] !== novalue), dp =>\r\n              ({\r\n                target: `${d.target}: ${dp[0]}`,\r\n                timestamp: dp[1]\r\n              }))\r\n          )\r\n          , (acc, v) => acc.concat(v), [])\r\n      )\r\n    );\r\n  }\r\n\r\n  annotationReplace(text, match){\r\n    if(!text || !match) return text;\r\n    for(var s in match){\r\n      text = text.replace(new RegExp(`\\\\$${s}`, 'g'), match[s]);\r\n    }\r\n    return this.templateSrv.replace(text, null, 'regex');\r\n  }\r\n\r\n  annotationInfo(options, result) {\r\n    var m = options.regexp ? new RegExp(options.regexp).exec(result.target):\r\n            [];\r\n    return {\r\n      \"title\": this.annotationReplace(options.title, m),\r\n      \"time\": result.timestamp,\r\n      \"text\": this.annotationReplace(options.text, m),\r\n      \"tags\": this.annotationReplace(options.tags, m)\r\n    };\r\n  }\r\n\r\n  createAnnotations(options, queryResult) {\r\n    var res = _.map(queryResult, r => Object.assign({\r\n      \"annotation\": {\r\n        \"name\": options.annotation.name,\r\n        \"enabled\": options.annotation.enable,\r\n        \"datasource\": \"Timelion\",\r\n      }},\r\n      this.annotationInfo(options.annotation, r)\r\n    ));\r\n    return res;\r\n  }\r\n\r\n  metricFindQuery(query) {\r\n    var interpolated = {\r\n      target: this.templateSrv.replace(query, null, 'regex')\r\n    };\r\n    return this[\"query\"]({\r\n      targets: [interpolated],\r\n      range: this.timeSrv.timeRange(),\r\n      scopedVars: {}\r\n    })\r\n      .then(series => {\r\n        return _.map(series.data, d => ({ text: d.target }));\r\n      });\r\n  }\r\n\r\n  mapToTextValue(result) {\r\n    return _.map(result.data, (d, i) => {\r\n      if (d && d.text && d.value) {\r\n        return { text: d.text, value: d.value };\r\n      } else if (_.isObject(d)) {\r\n        return { text: d, value: i };\r\n      }\r\n      return { text: d, value: d };\r\n    });\r\n  }\r\n\r\n  buildQueryParameters(options) {\r\n    var oThis = this;\r\n    //remove placeholder targets\r\n    options.targets = _.filter(options.targets, target => {\r\n      return target.target !== 'select metric' && !target.hide;\r\n    });\r\n\r\n    const queryTpl = {\r\n      \"sheet\": null,\r\n      \"time\": {\r\n        \"from\": options.range.from.utc().format(\"YYYY-MM-DDTHH:mm:ss\\\\Z\"),\r\n        \"interval\": \"auto\",\r\n        \"mode\": \"absolute\",\r\n        \"timezone\": \"GMT\",\r\n        \"to\": options.range.to.utc().format(\"YYYY-MM-DDTHH:mm:ss\\\\Z\")\r\n      }\r\n    };\r\n    var expandTemplate = function (target) {\r\n      _.map(Object.keys(options.scopedVars), key =>\r\n        target = target.replace(\"$\" + key, options.scopedVars[key].value));\r\n      return oThis.templateSrv\r\n        .replace(target, true)\r\n        .replace(/\\r\\n|\\r|\\n/mg, \"\")\r\n        .trim();\r\n    };\r\n    var targets = _.map(options.targets, target => {\r\n      return {\r\n        target: expandTemplate(target.target),\r\n        interval: expandTemplate(target.interval || \"auto\")\r\n      };\r\n    });\r\n    var variables = _.filter(_.map(options.targets, t => expandTemplate(t.target)),\r\n      t => t.indexOf(\"$\") == 0)\r\n      .join(\",\");\r\n    var intervalGroups = _.groupBy(targets, t => t.interval);\r\n    var intervals = Object.keys(intervalGroups);\r\n    var queries = _.map(intervals, key => ({\r\n      interval: key,\r\n      sheet: _.map(intervalGroups[key], target => (variables && variables.length) ?\r\n        [variables, target.target].join(\",\") :\r\n        target.target)\r\n    }));\r\n    options.queries = _.map(queries, q => {\r\n      queryTpl.sheet = q.sheet;\r\n      queryTpl.time.interval = !q.interval || q.interval === 'undefined' ? 'auto' : q.interval;\r\n      return _.cloneDeep(queryTpl);\r\n    });\r\n    return options;\r\n  }\r\n}\r\n"]}